<?php
/***********************************************
file: business.php
creator: Ian McEachern

This file outputs the active posting for a given
business and the relevant business data.
 ***********************************************/
require('includes/includes.php');
require('includes/db_interface.php');

connect_to_db($mysql_user, $mysql_pass, $mysql_db);

analyze_user();
//verify_logged_in();

//set variables
//body
$b_flag = false;
if(isset($_GET['b_id']))
{
	$b_id = sanitize($_GET['b_id']);
	$b_flag = true;
}

//head
$GLOBALS['header_html_title'] = "tndrbox - ";
$GLOBALS['header_scripts'] = "";
$GLOBALS['header_title'] = "";
$GLOBALS['header_body_includes'] = "";

require('includes/prints.php');

print_head();
print_body();
print_foot();

disconnect_from_db();

function print_body()
{
  echo "
	<div id=\"\" class =\"content-pane\">";
	
	if($b_flag == true)
	{
	//print business info
	$b_id = $GLOBALS['b_id'];
 	$query = "SELECT * FROM business where id='$b_id'";
 	$result = query_db($query);
  	if(mysql_num_rows($result)==1)
  	{
		extract($result);
		echo "
		<div id=\"bar_info\">
		      <table width=\"95%\"><tr>
		      	     <td><h2>";
		if($url != "")
		{
			echo "<a href=\"http://$url\">";
			if($logo != "")
			{
				echo "<img src=\"images/$logo\" width=\"300\" title=\"$name\" alt=\"$name\">";
			}
			else
			{
				echo $name;
			}
			echo "</a>";
		}
		else
		{
			if($logo != "")
			{
				echo "<img src=\"images/$logo\" width=\"300\" title=\"$name\" alt=\"$name\">";
			}
			else
			{
				echo $name;
			}
		}
		echo "</h2>
			<br><h3>$address<br>";
		echo "
			$city, $state, $zip<br><br>";
		echo "
			$number</h3><br>";
		$hours = explode(",", $hours);
		foreach($hours as $line)
		{
			echo "
			$line<br>";
		}
		echo "
			</td>
			<td style=\"text-align:right\">";
		if($lat == "" || $lon == "")
		{
			echo "
			<img src=\"http://maps.googleapis.com/maps/api/staticmap?center=$address $city $state $zip&zoom=16&size=300x400&markers=color:red|$address $city $state $zip&sensor=false\">";
		}
		else
		{
			echo "
			<img src=\"http://maps.googleapis.com/maps/api/staticmap?center=$lat,$lon&zoom=16&size=300x400&markers=color:red|$lat,$lon&sensor=false\">";    
		}
		echo "
			</td>
			</tr></table>
			</div>
		</div>";

  	//print active business posting
	$query = "SELECT * FROM postings WHERE b_id='$b_id' LIMIT 1 ORDER BY posting_time ASC";
	$result = query_db($query);
	$posting = mysql_fetch_array($result);
		extract($posting);
		$query = "SELECT tag FROM tags WHERE id='$tag_1' AND id='$tag_2' AND id='$tag_3'";
		$tags_result = query_db($query);
		$j = 0;
		while($tag = mysql_fetch_array($tags_result))
		  {
			if(++$j == 1)
			  {
				$tags[$tag_1] = $tag['tag']; 
			  }
			else if($j == 2)
			  {
				$tags[$tag_2] = $tag['tag'];
			  }
			else if($j == 3)
			  {
				$tags[$tag_3] = $tag['tag'];
			  }
		  }
		echo "
			<div id=\"posting_border_1\">
				<div class=\"posting-1-title\">$title</div>
				<div class=\"posting-1-time\">$posting_time</div>
				<div class=\"posting-1-data\">
					<img src=\"$photo\" alt=\"photo for $title\" class=\"posting-image\">
					<div class=\"posting-1-blurb\">
						$blurb
					</div>
					<ul>
						<li><a href=\"tags?id=$tag_1\">$tags[$tag_1]</a></li>
						<li><a href=\"tags?id=$tag_2\">$tags[$tag_2]</a></li>
						<li><a href=\"tags?id=$tag_3\">$tags[$tag_3]</a></li>
					</ul>
				</div>
			</div>";
	  }
	  else
	  {
		$b_flag = false;
	  }
	  if($b_flag == false)
	  {
	       	$db_query = "SELECT name, id, logo  FROM businesses ORDER BY name";
		$result = query_db($db_query);
		echo "
		     <table width=\"100%\">";
		
		$count=0;
		
		while($business = mysql_fetch_array($result))
		{
				if($count == 0)
				{
					echo "
			<tr>";
				}
				extract($business);
				echo "
				<td align=\"center\">
				<br>
		     		<a href=\"?id=".$id."\" title=\"".$name."\">";
				if($logo == "")
				{
					echo "
	     	     		<div class=\"bus_button\">
				 <span>".$name."</span>
		     		</div>";
				}
		     	  	else
				{
					echo "
				<img src=\"images/".$logo."\" alt=\"".$name."\" border=\"0\" width=\"200\">";
				}
				echo "</a><br>
				</td>";

				if(++$count == 4)
				{
					$count = 0;
					echo "
			</tr>";
				} 	
		}
		if($count != 0)
		{
			echo "
			</tr>";
		}
		echo "
		     </table>";
	} 	
	echo "	
	</div>";
}
?>